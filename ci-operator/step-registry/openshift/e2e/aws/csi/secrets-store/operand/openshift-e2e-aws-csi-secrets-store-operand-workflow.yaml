workflow:
  as: openshift-e2e-aws-csi-secrets-store-operand
  steps:
    pre:
      - chain: ipi-aws-pre-manual-oidc-sts
      - ref: storage-create-csi-secrets-store-operand
      - ref: storage-obj-save
      - ref: openshift-e2e-aws-csi-secrets-store-iam-access
    test:
      - as: test-e2e-aws
        cli: latest
        commands: |
          # Set varaibles needed to login to AWS
          export AWS_SHARED_CREDENTIALS_FILE="${CLUSTER_PROFILE_DIR}/.awscred"
          export AWS_CONFIG_FILE=$CLUSTER_PROFILE_DIR/.aws

          KEY_ID=$(cat $AWS_SHARED_CREDENTIALS_FILE | grep aws_access_key_id | tr -d ' ' | cut -d '=' -f 2)
          ACCESS_KEY=$(cat $AWS_SHARED_CREDENTIALS_FILE | grep aws_secret_access_key | tr -d ' ' | cut -d '=' -f 2)
          export AWS_ACCESS_KEY_ID=$KEY_ID
          export AWS_SECRET_ACCESS_KEY=$ACCESS_KEY

          if [[ ${AWS_ACCESS_KEY_ID} == "" ]] || [[ ${AWS_SECRET_ACCESS_KEY} == "" ]]; then
            echo "Did not find AWS credential, exit now"
            exit 1
          fi

          aws_region=${REGION:-$LEASED_RESOURCE}
          export REGION=$aws_region

          # Replace
          curl -L -o test/bats/aws.bats https://raw.githubusercontent.com/openshift/secrets-store-csi-driver/a94f439c57ae34b66b166293474e3a47aeea3f42/test/bats/aws.bats

          # Run aws-e2e
          # make e2e-aws
          cat test/bats/aws.bats
          bats --trace --verbose-run --show-output-of-passing-tests --print-output-on-failure test/bats/aws.bats
        from: secrets-store-csi-driver-test
        resources:
          requests:
            cpu: 50m
            memory: 100Mi
      - as: sleeper
        commands: |
          #!/bin/bash
          total_duration=21300 # 5h55m, timeout is 6h
          elapsed_time=0
          while [ $elapsed_time -lt $total_duration ]; do
              sleep 30
              elapsed_time=$((elapsed_time + 30))
              echo "Elapsed time: $((elapsed_time / 3600)) hours $(((elapsed_time % 3600) / 60)) minutes $((elapsed_time % 60)) seconds"
          done
        from: secrets-store-csi-driver-test
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
        timeout: 6h0m0s
    post:
      - ref: storage-obj-check
      - chain: ipi-aws-post-manual-oidc-sts
  documentation: |-
    The workflow TODO.
